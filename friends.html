
<main>
  <h2>Friends</h2>

  <section class="friend-requests">
    <h3>Incoming Requests</h3>
    <div id="incomingList"></div>
  </section>

  <section class="friend-requests">
    <h3>Outgoing Requests</h3>
    <div id="outgoingList"></div>
  </section>

  <section class="send-request">
    <h3>Send Friend Request</h3>
    <input id="friendEmail" placeholder="Enter email">
    <button id="sendFriendReq">Send Request</button>
  </section>

  <section class="friend-list">
    <h3>Your Friends</h3>
    <div id="friendsList"></div>
  </section>

  <section id="dmSection" style="display:none">
    <h3>DM with <span id="dmUser"></span></h3>
    <div id="dmMessages" style="height:200px;overflow-y:auto;background:#222;padding:10px"></div>
    <input id="dmText" placeholder="Message...">
    <button id="sendDmBtn">Send</button>
  </section>
</main>

<script>
// Firebase friend system + DM logic
function sanitize(e){ return e.toLowerCase().replace(/\./g,'_'); }

firebase.auth().onAuthStateChanged(u=>{
 if(!u) return;

 let uid=u.uid;

 // Send friend request
 document.getElementById("sendFriendReq").onclick=()=>{
   let email=document.getElementById("friendEmail").value.trim();
   if(!email) return;
   let id=sanitize(email);
   firebase.database().ref("friend_requests/"+id+"/"+uid).set({
     from:u.email, uid:uid, ts:Date.now()
   });
   alert("Request sent!");
 };

 // Incoming
 firebase.database().ref("friend_requests/"+sanitize(u.email)).on("value",snap=>{
   let box=document.getElementById("incomingList");
   box.innerHTML="";
   snap.forEach(ch=>{
     let v=ch.val();
     box.innerHTML+=\`<div>\${v.from} <button onclick="acceptReq('\${v.uid}')">Accept</button></div>\`;
   });
 });

 // Accept
 window.acceptReq=(other)=>{
   firebase.database().ref("friends/"+uid+"/"+other).set(true);
   firebase.database().ref("friends/"+other+"/"+uid).set(true);
   firebase.database().ref("friend_requests/"+sanitize(u.email)+"/"+other).remove();
 };

 // Outgoing
 firebase.database().ref("friend_requests").on("value",snap=>{
   let box=document.getElementById("outgoingList");
   box.innerHTML="";
   snap.forEach(target=>{
     target.forEach(req=>{
       if(req.val().uid===uid){
         box.innerHTML+=\`<div>To: \${target.key.replace(/_/g,'.')}</div>\`;
       }
     });
   });
 });

 // Friends list
 firebase.database().ref("friends/"+uid).on("value",snap=>{
   let box=document.getElementById("friendsList");
   box.innerHTML="";
   snap.forEach(ch=>{
     let other=ch.key;
     firebase.database().ref("users/"+other).once("value").then(uSnap=>{
       let email=uSnap.val().email;
       box.innerHTML+=\`<div><button onclick="openDm('\${other}','\${email}')">DM \${email}</button></div>\`;
     });
   });
 });

 // DM
 window.openDm=(other,email)=>{
   document.getElementById("dmSection").style.display="block";
   document.getElementById("dmUser").innerText=email;

   let path="dms/"+uid+"/"+other;
   firebase.database().ref(path).on("value",snap=>{
     let box=document.getElementById("dmMessages");
     box.innerHTML="";
     snap.forEach(ch=>{ box.innerHTML+=\`<div>\${ch.val().from}: \${ch.val().text}</div>\`; });
   });

   document.getElementById("sendDmBtn").onclick=()=>{
     let msg=document.getElementById("dmText").value;
     if(!msg) return;
     firebase.database().ref(path).push({from:u.email, text:msg, ts:Date.now()});
     firebase.database().ref("dms/"+other+"/"+uid).push({from:u.email, text:msg, ts:Date.now()});
     document.getElementById("dmText").value="";
   };
 };
});
</script>
