
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ChatPack - Rooms</title>
<link rel="stylesheet" href="css/style.css">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="js/firebase_init.js"></script>
<script src="js/auth.js"></script>
</head><body class="theme-dark">
<div class="app">
  <aside class="sidebar"><a class="icon" href="admin.html" title="Admin Panel">üõ†Ô∏è</a>
    
<!-- Admin & Friends Quick Links -->
<div style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
  <a class="icon" href="friends.html" title="Friends">üë•</a>
  <a class="icon" href="requests.html" title="Requests">üì®</a>
  <a id="adminQuick" class="icon" href="admin.html" title="Admin" style="display:none">‚öôÔ∏è</a>
</div>
<script>
// show admin link if current user is admin (stored in localStorage ADMIN_EMAIL)
firebase && firebase.auth && firebase.auth().onAuthStateChanged(function(u){
  if(!u) return;
  var admin = (localStorage.getItem('ADMIN_EMAIL')||'proadmin@proton.me').trim().toLowerCase();
  if(u.email && u.email.trim().toLowerCase()===admin){
    var el = document.getElementById('adminQuick');
    if(el) el.style.display='inline-flex';
  }
});
</script>
<div class="logo"><img src="assets/server_logo.svg" style="width:48px;height:48px"></div>
    <a class="icon" href="chat.html" title="Home">üè†</a>
    <a class="icon" href="dm.html" title="DMs">üí¨</a>
    <a class="icon" href="friends.html" title="Friends">üë•</a>
    <a class="icon" href="games.html" title="Games">üéÆ</a>
    <a class="icon" href="notifications.html" title="Notifications">üîî</a>
  </aside>
  <div class="main">
    <div class="header"><div class="server-title">ChatPack</div></div>
    <div class="content">
      <div class="channels">
        <div><strong>ROOMS</strong></div>
        <div id="roomList"></div>
        <div style="margin-top:12px"><input id="newRoom" placeholder="New room name"><button id="createRoomBtn">Create</button></div>
      </div>
      <div class="chat-area">
        <div id="chatWindow" class="chat-window"></div>
        <div class="input-row"><input id="chatInput" placeholder="Message"><button id="sendBtn">Send</button></div>
      </div>
    </div>
  </div>
</div>

<script src="js/firebase_init.js"></script>
<script src="js/auth.js"></script>
<script src="js/online.js"></script>
<script src="js/admin.js"></script>
<script>

// initialize rooms list and create room
var db = firebase.database();
var auth = firebase.auth();
auth.onAuthStateChanged(function(user){
  if(!user) return window.location.href='index.html';
  loadRooms();
});
function loadRooms(){
  var rl = document.getElementById('roomList');
  rl.innerHTML='';
  db.ref('rooms').once('value').then(function(snap){
    snap.forEach(function(ch){
      var k = ch.key;
      var el = document.createElement('div');
      el.textContent = k;
      el.style.cursor='pointer';
      el.onclick = function(){ joinRoom(k); };
      rl.appendChild(el);
    });
  });
}
document.getElementById('createRoomBtn').addEventListener('click', function(){
  var name = document.getElementById('newRoom').value.trim(); if(!name) return alert('Enter name');
  var key = name.replace(/\s+/g,'_').toLowerCase();
  db.ref('rooms/'+key).set({name:name,created:Date.now()}).then(function(){ loadRooms(); document.getElementById('newRoom').value=''; });
});
var currentRoom = 'global';
function joinRoom(room){
  currentRoom = room;
  document.getElementById('chatWindow').innerHTML='';
  var list = db.ref('chatrooms/'+room+'/messages');
  list.off();
  list.limitToLast(200).on('child_added', function(snap){
    var m = snap.val();
    var d = document.createElement('div');
    d.className = 'message';
    var av = document.createElement('div'); av.className='avatar'; av.style.width='40px'; av.style.height='40px'; av.style.borderRadius='50%';
    var img = document.createElement('img'); img.style.width='40px'; img.style.height='40px'; img.src='https://via.placeholder.com/40';
    av.appendChild(img);
    var bubble = document.createElement('div'); bubble.className='bubble';
    var meta = document.createElement('div'); meta.className='meta'; meta.textContent = m.user + ' ‚Ä¢ ' + new Date(m.time).toLocaleTimeString();
    var txt = document.createElement('div'); txt.textContent = m.msg;
    bubble.appendChild(meta); bubble.appendChild(txt);
    d.appendChild(av); d.appendChild(bubble);
    document.getElementById('chatWindow').appendChild(d);
    document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
  });
}
document.getElementById('sendBtn').addEventListener('click', function(){
  var user = auth.currentUser; if(!user) return alert('Login required');
  var msg = document.getElementById('chatInput').value.trim(); if(!msg) return;
  db.ref('chatrooms/'+currentRoom+'/messages').push({ user: user.email, uid: user.uid, msg: msg, time: Date.now() });
  document.getElementById('chatInput').value='';
});
</script>


<script>
firebase.auth().onAuthStateChanged(function(u){
  if(!u) return;
  var key = u.email.replace(/\./g,'_').toLowerCase();
  firebase.database().ref('inbox/'+key).limitToLast(1).on('value', function(snap){ var el=document.getElementById('inboxDot'); if(!el) return; if(snap.exists()) el.style.display='inline-block'; else el.style.display='none'; });
});
</script>


<!-- GLOBAL CUSTOMIZATION LOADER -->
<script>
(function(){
  const custom = JSON.parse(localStorage.getItem('siteCustom')||'{}');
  if(custom.bgUrl){ document.body.style.backgroundImage = `url(${custom.bgUrl})`; }
  if(custom.accentColor){
    document.documentElement.style.setProperty('--accent', custom.accentColor);
  }
  if(custom.logoUrl){
    const logo=document.querySelector('.site-logo');
    if(logo) logo.src=custom.logoUrl;
  }
  if(custom.siteTitle){
    const t=document.querySelector('.site-title');
    if(t) t.textContent=custom.siteTitle;
    document.title = custom.siteTitle;
  }
})();
</script>

</body></html>