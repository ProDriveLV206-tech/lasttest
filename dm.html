<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>dm.html</title>
<link rel="stylesheet" href="css/style.css">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="js/auth.js"></script>
<script src="js/firebase_init.js"></script><script src="js/auth.js"></script></head><body class="theme-dark"><div class="app"><aside class="sidebar"><a class="icon" href="admin.html" title="Admin Panel">üõ†Ô∏è</a>
<!-- Admin & Friends Quick Links -->
<div style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
  <a class="icon" href="friends.html" title="Friends">üë•</a>
  <a class="icon" href="requests.html" title="Requests">üì®</a>
  <a id="adminQuick" class="icon" href="admin.html" title="Admin" style="display:none">‚öôÔ∏è</a>
</div>
<script>
// show admin link if current user is admin (stored in localStorage ADMIN_EMAIL)
firebase && firebase.auth && firebase.auth().onAuthStateChanged(function(u){
  if(!u) return;
  var admin = (localStorage.getItem('ADMIN_EMAIL')||'proadmin@proton.me').trim().toLowerCase();
  if(u.email && u.email.trim().toLowerCase()===admin){
    var el = document.getElementById('adminQuick');
    if(el) el.style.display='inline-flex';
  }
});
</script>
<div class="logo"><img src="assets/server_logo.svg" style="width:48px;height:48px"></div><a class="icon" href="chat.html">üè†</a><a class="icon" href="dm.html">üí¨</a><a class="icon" href="friends.html">üë•</a><a class="icon" href="games.html">üéÆ</a><a class="icon" href="notifications.html">üîî</a></aside><div class="main"><div class="header"><div class="server-title">ChatPack</div></div><div class="content"><div class="channels" style="display:none"></div><div class="chat-area"><header style="padding:12px;background:var(--card)">ChatPack</header><main class="container"><div class="card"><h2>dm.html</h2><p>Content here</p></div>
<h2>Direct Messages</h2>
<div id='users'></div>
<div id='thread'></div>

<script>
// Load users
firebase.database().ref('users').on('value',snap=>{
 let ulist='';
 let cur=firebase.auth().currentUser;
 snap.forEach(ch=>{
   if(ch.key!=cur.uid){
     let name=ch.val().name||'User';
     ulist+=`<div onclick="openDM('${ch.key}','${cur.uid}')">${name}</div>`;
   }
 });
 document.getElementById('users').innerHTML=ulist;
});

function openDM(other, me){
 let room = [me,other].sort().join('_');
 window.currentRoom=room;
 firebase.database().ref('dms/'+room).off();
 firebase.database().ref('dms/'+room).on('value',s=>{
   let out='';
   s.forEach(m=>{
     let d=m.val();
     out+=`<div><b>${d.from}</b>: ${d.text}</div>`;
   });
   document.getElementById('thread').innerHTML = out + 
     `<input id='msg'><button onclick='sendDM()'>Send</button>`;
 });
}

function sendDM(){
 let cur=firebase.auth().currentUser;
 let text=document.getElementById('msg').value;
 if(!text)return;
 let room=window.currentRoom;
 firebase.database().ref('dms/'+room).push({
   from:cur.email,
   text:text,
   ts:Date.now()
 });
 document.getElementById('msg').value='';
}
</script>

<div>
<h3>Send DM by Email</h3>
<input id='targetEmail' placeholder='email'>
<input id='emailMsg' placeholder='message'>
<button onclick='sendEmailDM()'>Send</button>
</div>
<script>
function sendEmailDM(){
 let cur=firebase.auth().currentUser;
 let target=document.getElementById('targetEmail').value.trim().toLowerCase();
 let msg=document.getElementById('emailMsg').value;
 if(!target||!msg)return;
 let key=target.replace(/\./g,'_');
 firebase.database().ref('inbox/'+key).push({
   from:cur.email,
   text:msg,
   ts:Date.now()
 });
 alert('Sent');
}
</script>

<script>
function getQuery(){ var q={}; location.search.slice(1).split('&').forEach(function(p){ if(!p) return; var parts=p.split('='); q[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1]||''); }); return q; }
function startDMFromQuery(){ var q=getQuery(); if(q.to){ document.getElementById('targetEmail').value = q.to; } }
startDMFromQuery();
</script>

<!-- GLOBAL CUSTOMIZATION LOADER -->
<script>
(function(){
  const custom = JSON.parse(localStorage.getItem('siteCustom')||'{}');
  if(custom.bgUrl){ document.body.style.backgroundImage = `url(${custom.bgUrl})`; }
  if(custom.accentColor){
    document.documentElement.style.setProperty('--accent', custom.accentColor);
  }
  if(custom.logoUrl){
    const logo=document.querySelector('.site-logo');
    if(logo) logo.src=custom.logoUrl;
  }
  if(custom.siteTitle){
    const t=document.querySelector('.site-title');
    if(t) t.textContent=custom.siteTitle;
    document.title = custom.siteTitle;
  }
})();
</script>

</body><button onclick='history.back()'>Back</button>

<!-- GLOBAL CUSTOMIZATION LOADER -->
<script>
(function(){
  const custom = JSON.parse(localStorage.getItem('siteCustom')||'{}');
  if(custom.bgUrl){ document.body.style.backgroundImage = `url(${custom.bgUrl})`; }
  if(custom.accentColor){
    document.documentElement.style.setProperty('--accent', custom.accentColor);
  }
  if(custom.logoUrl){
    const logo=document.querySelector('.site-logo');
    if(logo) logo.src=custom.logoUrl;
  }
  if(custom.siteTitle){
    const t=document.querySelector('.site-title');
    if(t) t.textContent=custom.siteTitle;
    document.title = custom.siteTitle;
  }
})();
</script>

</body></html></div></div></div></div>
<!-- GLOBAL CUSTOMIZATION LOADER -->
<script>
(function(){
  const custom = JSON.parse(localStorage.getItem('siteCustom')||'{}');
  if(custom.bgUrl){ document.body.style.backgroundImage = `url(${custom.bgUrl})`; }
  if(custom.accentColor){
    document.documentElement.style.setProperty('--accent', custom.accentColor);
  }
  if(custom.logoUrl){
    const logo=document.querySelector('.site-logo');
    if(logo) logo.src=custom.logoUrl;
  }
  if(custom.siteTitle){
    const t=document.querySelector('.site-title');
    if(t) t.textContent=custom.siteTitle;
    document.title = custom.siteTitle;
  }
})();
</script>

</body></html>